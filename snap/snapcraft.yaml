name: notes
adopt-info: notes
icon: packaging/linux/common/icons/512x512/notes.png

base: core22
compression: lzo
confinement: strict

architectures:
  - build-on: amd64
  - build-on: arm64

apps:
  notes:
    common-id: io.github.nuttyartist.notes
    command-chain:
      - bin/graphics-core22-wrapper
    command: usr/bin/notes
    plugs:
      - desktop
      - desktop-legacy
      - gsettings
      - home
      - network
      - opengl
      - unity7
      - x11
      - wayland
    environment:
      QML2_IMPORT_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/qt6/qml
      QT_PLUGIN_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/qt6/plugins
      QT_QPA_PLATFORM_PLUGIN_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/qt6/plugins/platforms
      XCURSOR_PATH: $SNAP/share/icons
      XDG_CACHE_HOME: $SNAP_USER_COMMON/.cache
      XDG_CONFIG_HOME: $SNAP_USER_DATA/.config
      XDG_CONFIG_DIRS: $SNAP/etc/xdg
      XKB_CONFIG_ROOT: $SNAP/usr/share/X11/xkb

layout:
  /usr/share/libdrm:
    bind: $SNAP/graphics/libdrm
  /usr/share/drirc.d:
    symlink: $SNAP/graphics/drirc.d
  /usr/share/X11/XErrorDB:
    symlink: $SNAP/graphics/X11/XErrorDB
  /usr/share/X11/locale:
    symlink: $SNAP/graphics/X11/locale
  /usr/share/X11/xkb:
    bind: $SNAP/usr/share/X11/xkb

plugs:
  graphics-core22:
    interface: content
    target: $SNAP/graphics
    default-provider: mesa-core22
  gtk-3-themes:
    interface: content
    target: $SNAP/share/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/share/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/share/sounds
    default-provider: gtk-common-themes

parts:
  notes:
    source: .
    source-type: git
    plugin: cmake
    cmake-generator: Ninja
    cmake-parameters:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DGIT_REVISION=ON
      - -DPRO_VERSION=OFF
      - -DUPDATE_CHECKER=OFF
      - -DUSE_QT_VERSION=6
    parse-info:
      - usr/share/metainfo/io.github.nuttyartist.notes.metainfo.xml
    build-packages:
      - libgl-dev
      - libqt6opengl6-dev
      - qt6-base-private-dev
      - qt6-declarative-dev
    stage-packages:
      - libqt6network6
      - libqt6sql6-sqlite
      - libqt6widgets6
      - libxcursor1
      - qml6-module-qtqml-workerscript
      - qml6-module-qtquick-controls
      - qml6-module-qtquick-layouts
      - qml6-module-qtquick-particles
      - qml6-module-qtquick-templates
      - qml6-module-qtquick-window
      - qt6-qpa-plugins
    override-prime: |
      craftctl default
      if [ -d "${SNAPCRAFT_PART_SRC}/.git" ]
      then
        craftctl set version="$(grep -oPm1 '\bAPP_VERSION +\K[^)]+' "${SNAPCRAFT_PART_SRC}/CMakeLists.txt")+g$(git -C "${SNAPCRAFT_PART_SRC}" rev-parse --short HEAD)"
      fi

  graphics-core22:
    after:
      - notes
    source: https://github.com/MirServer/graphics-core22.git
    plugin: dump
    override-prime: |
      craftctl default
      ${CRAFT_PART_SRC}/bin/graphics-core22-cleanup mesa-core22 nvidia-core22
    prime:
      - bin/graphics-core22-wrapper
